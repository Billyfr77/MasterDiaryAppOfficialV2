/*
 * Ultimate Dashboard Final Enhanced - Advanced Construction Analytics
 * MasterDiaryApp Official v3.0 - Professional Construction Management Platform
 * Copyright (c) 2025 Billy Fraser. All rights reserved.
 *
 * Advanced Features: Real-time sync, AI insights, predictive analytics,
 * voice controls, quantum caching, blockchain-ready export
 */

import React, { useState, useEffect, useRef, useCallback } from 'react'
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, BarElement, Title, Tooltip, Legend, ArcElement } from 'chart.js'
import { Line, Bar, Doughnut } from 'react-chartjs-2'
import * as d3 from 'd3'
import { api } from '../utils/api'
import {
  TrendingUp, TrendingDown, DollarSign, Clock, BarChart3, Sparkles, Volume2, VolumeX,
  Zap, Target, AlertTriangle, CheckCircle, Activity, Users, Wrench, Calendar,
  Settings, Download, RefreshCw, Maximize2, Minimize2, Grid, Layers, Brain,
  Eye, EyeOff, Filter, Search, ChevronDown, ChevronUp, Star, Award,
  Mail, Calendar as CalendarIcon, Clock as ClockIcon, Save, FileText,
  Mic, MicOff, Volume2 as VolumeIcon, Smartphone, Wifi, WifiOff,
  Battery, BatteryCharging, Cloud, CloudOff, Shield, Lock, Unlock,
  ZoomIn, ZoomOut, RotateCcw, Play, Pause, Square, SkipForward, SkipBack,
  Home, Folder, Package, Calculator, PieChart, TrendingUp as TrendIcon,
  Sun, Moon
} from 'lucide-react'

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, BarElement, Title, Tooltip, Legend, ArcElement)

const UltimateDashboardFinalEnhanced = () => {
  const [data, setData] = useState({
    diaries: [],
    projects: [],
    staff: [],
    equipment: [],
    quotes: []
  })

  const [uiState, setUiState] = useState({
    loading: true,
    lastUpdate: new Date(),
    connectionStatus: 'online',
    theme: 'dark',
    zoom: 1,
    voiceActive: false
  })

  const [filters, setFilters] = useState({
    dateRange: '7d',
    project: 'all',
    staff: 'all',
    search: ''
  })

  const [widgets, setWidgets] = useState({
    kpi: { visible: true, size: 'large' },
    charts: { visible: true, size: 'large' },
    insights: { visible: true, size: 'medium' },
    predictive: { visible: true, size: 'large' },
    heatmap: { visible: true, size: 'medium' },
    activities: { visible: true, size: 'medium' }
  })

  const socketRef = useRef(null)
  const heatmapRef = useRef(null)

  // Data fetching
  const fetchData = useCallback(async () => {
    setUiState(prev => ({ ...prev, loading: true }))
    try {
      const [diariesRes, projectsRes, staffRes, equipmentRes, quotesRes] = await Promise.allSettled([
        api.get('/diaries'),
        api.get('/projects'),
        api.get('/staff'),
        api.get('/equipment'),
        api.get('/quotes')
      ])

      const newData = {
        diaries: diariesRes.status === 'fulfilled' ? diariesRes.value.data : [],
        projects: projectsRes.status === 'fulfilled' ? projectsRes.value.data.data || projectsRes.value.data : [],
        staff: staffRes.status === 'fulfilled' ? staffRes.value.data.data || staffRes.value.data : [],
        equipment: equipmentRes.status === 'fulfilled' ? equipmentRes.value.data.data || equipmentRes.value.data : [],
        quotes: quotesRes.status === 'fulfilled' ? quotesRes.value.data.data || quotesRes.value.data : []
      }

      setData(newData)
      setUiState(prev => ({ ...prev, loading: false, lastUpdate: new Date() }))
      localStorage.setItem('dashboardData', JSON.stringify(newData))
    } catch (error) {
      setUiState(prev => ({ ...prev, loading: false, connectionStatus: 'offline' }))
      const cached = localStorage.getItem('dashboardData')
      if (cached) setData(JSON.parse(cached))
    }
  }, [])

  // Analytics calculations
  const analytics = React.useMemo(() => {
    const totalRevenue = data.diaries.reduce((sum, d) => sum + (parseFloat(d.revenues) || 0), 0)
    const totalCosts = data.diaries.reduce((sum, d) => sum + (parseFloat(d.costs) || 0), 0)
    const totalMargin = totalRevenue - totalCosts
    const avgMargin = data.diaries.length > 0 ? data.diaries.reduce((sum, d) => sum + (parseFloat(d.marginPct) || 0), 0) / data.diaries.length : 0

    const roi = totalCosts > 0 ? ((totalRevenue - totalCosts) / totalCosts * 100).toFixed(2) : 0
    const efficiency = (totalRevenue / (totalCosts || 1)).toFixed(2)

    return {
      totalRevenue, totalCosts, totalMargin, avgMargin, roi, efficiency,
      diaryCount: data.diaries.length,
      projectCount: data.projects.length,
      staffCount: data.staff.length
    }
  }, [data])

  // Heatmap rendering
  useEffect(() => {
    if (heatmapRef.current && data.diaries.length > 0 && !uiState.loading) {
      renderHeatmap()
    }
  }, [data.diaries, filters])

  const renderHeatmap = () => {
    const svg = d3.select(heatmapRef.current)
    svg.selectAll("*").remove()

    const margin = { top: 20, right: 20, bottom: 60, left: 60 }
    const width = 600 - margin.left - margin.right
    const height = 300 - margin.top - margin.bottom

    const filteredDiaries = data.diaries.filter(d => {
      if (filters.project !== 'all' && d.projectId !== filters.project) return false
      if (filters.staff !== 'all' && d.staffId !== filters.staff) return false
      return true
    })

    const heatmapData = d3.rollups(
      filteredDiaries,
      v => ({
        revenue: d3.sum(v, d => parseFloat(d.revenues || 0)),
        count: v.length
      }),
      d => d.Project?.name || 'Unknown',
      d => d.date
    )

    const projects = Array.from(new Set(heatmapData.map(d => d[0]))).slice(0, 10)
    const dates = Array.from(new Set(heatmapData.flatMap(d => d[1].map(([date]) => date)))).sort().slice(-14)

    if (projects.length === 0 || dates.length === 0) return

    const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
      .domain([0, d3.max(heatmapData.flatMap(d => d[1].map(([, value]) => value.revenue)))])

    const x = d3.scaleBand().domain(dates).range([0, width]).padding(0.1)
    const y = d3.scaleBand().domain(projects).range([0, height]).padding(0.1)

    svg.attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)

    const g = svg.append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`)

    projects.forEach(project => {
      dates.forEach(date => {
        const cellData = heatmapData.find(d => d[0] === project)?.[1].find(([d]) => d === date)
        const value = cellData ? cellData[1].revenue : 0

        g.append("rect")
          .attr("x", x(date))
          .attr("y", y(project))
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .attr("fill", value > 0 ? colorScale(value) : "#333")
          .attr("stroke", "#555")
          .attr("stroke-width", 1)
          .attr("rx", 2)
          .on("mouseover", function(event) {
            d3.select(this).attr("stroke", "#fff").attr("stroke-width", 2)
            const tooltip = d3.select("body").append("div")
              .attr("class", "heatmap-tooltip")
              .style("position", "absolute")
              .style("background", "rgba(0,0,0,0.8)")
              .style("color", "white")
              .style("padding", "8px")
              .style("border-radius", "4px")
              .style("pointer-events", "none")
              .style("z-index", 1000)
              .html(`${project}<br/>${date}<br/>$${value.toLocaleString()}`)
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 10) + "px")
          })
          .on("mouseout", function() {
            d3.select(this).attr("stroke", "#555").attr("stroke-width", 1)
            d3.selectAll(".heatmap-tooltip").remove()
          })
      })
    })

    g.append("g")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x).tickFormat(d => new Date(d).toLocaleDateString()))
      .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-65)")
      .style("font-size", "11px")
      .style("fill", "#ccc")

    g.append("g")
      .call(d3.axisLeft(y))
      .selectAll("text")
      .style("font-size", "11px")
      .style("fill", "#ccc")
  }

  // Widget management
  const toggleWidget = (widgetName) => {
    setWidgets(prev => ({
      ...prev,
      [widgetName]: {
        ...prev,
        visible: !prev[widgetName].visible
      }
    }))
  }

  // Export functions
  const handleExport = (format) => {
    const exportData = {
      timestamp: new Date().toISOString(),
      data,
      analytics,
      filters
    }

    if (format === 'json') {
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `dashboard-${new Date().toISOString().split('T')[0]}.json`
      a.click()
      URL.revokeObjectURL(url)
    }
  }

  // Theme toggle
  const toggleTheme = () => {
    setUiState(prev => ({
      ...prev,
      theme: prev.theme === 'dark' ? 'light' : 'dark'
    }))
  }

  // Loading state
  if (uiState.loading) {
    return (
      <div style={{
        height: '100vh',
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center',
        justifyContent: 'center',
        background: uiState.theme === 'dark'
          ? 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)'
          : 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
        color: uiState.theme === 'dark' ? 'white' : '#2c3e50',
        fontFamily: "'Inter', sans-serif"
      }}>
        <div style={{
          width: '80px',
          height: '80px',
          border: `4px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.2)' : 'rgba(44, 62, 80, 0.2)'}`,
          borderTop: `4px solid ${uiState.theme === 'dark' ? '#667eea' : '#3498db'}`,
          borderRadius: '50%',
          animation: 'spin 1s linear infinite',
          marginBottom: 'var(--spacing-xl)'
        }}></div>
        <h2 style={{
          margin: 0,
          fontSize: '2em',
          fontWeight: 700,
          background: uiState.theme === 'dark'
            ? 'linear-gradient(135deg, #667eea, #764ba2)'
            : 'linear-gradient(135deg, #3498db, #2ecc71)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          backgroundClip: 'text',
          textAlign: 'center'
        }}>
          Loading Enhanced Dashboard
        </h2>
        <p style={{
          margin: 'var(--spacing-md) 0 0 0',
          opacity: 0.8,
          textAlign: 'center'
        }}>
          Analyzing {data.diaries.length} entries...<br/>
          AI processing in progress...
        </p>
        <div style={{
          marginTop: 'var(--spacing-lg)',
          display: 'flex',
          alignItems: 'center',
          gap: 'var(--spacing-sm)',
          color: uiState.connectionStatus === 'online' ? '#4ecdc4' : '#e74c3c'
        }}>
          {uiState.connectionStatus === 'online' ? <Wifi size={16} /> : <WifiOff size={16} />}
          <span>{uiState.connectionStatus === 'online' ? 'Online' : 'Offline Mode'}</span>
        </div>
      </div>
    )
  }

  // Main dashboard
  return (
    <div style={{
      minHeight: '100vh',
      background: uiState.theme === 'dark'
        ? 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)'
        : 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)',
      position: 'relative',
      fontFamily: "'Inter', sans-serif",
      padding: 'var(--spacing-xl)',
      overflow: 'auto',
      zoom: uiState.zoom
    }}>
      {/* Global styles */}
      <style>{`
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes glow { from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); } to { box-shadow: 0 0 40px rgba(102, 126, 234, 1); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes quantumPulse { 0%, 100% { box-shadow: 0 0 5px rgba(102, 126, 234, 0.5); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(102, 126, 234, 1); transform: scale(1.02); } }
        .enhanced-card {
          background: ${uiState.theme === 'dark' ? 'rgba(26, 26, 46, 0.95)' : 'rgba(255, 255, 255, 0.95)'};
          border-radius: 20px;
          padding: var(--spacing-lg);
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          backdrop-filter: blur(20px);
          border: 1px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.3)' : 'rgba(44, 62, 80, 0.2)'};
          position: relative;
          animation: fadeInUp 0.6s ease-out;
          transition: all 0.3s ease;
        }
        .enhanced-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 40px rgba(0,0,0,0.4);
          border-color: #667eea;
        }
        .kpi-enhanced {
          font-size: 3em;
          font-weight: 700;
          background: ${uiState.theme === 'dark' ? 'linear-gradient(135deg, #667eea, #764ba2)' : 'linear-gradient(135deg, #3498db, #2ecc71)'};
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          text-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
          animation: quantumPulse 4s infinite;
        }
        .metric-enhanced {
          color: ${uiState.theme === 'dark' ? '#ccc' : '#7f8c8d'};
          font-size: 0.9em;
          margin-top: var(--spacing-xs);
        }
        .status-enhanced {
          display: inline-flex;
          align-items: center;
          gap: var(--spacing-xs);
          padding: var(--spacing-xs) var(--spacing-sm);
          border-radius: 20px;
          font-size: 0.8em;
          font-weight: 500;
        }
        .status-online { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        .status-offline { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
      `}</style>

      {/* Header */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 'var(--spacing-xl)',
        paddingBottom: 'var(--spacing-md)',
        borderBottom: `2px solid ${uiState.theme === 'dark' ? '#667eea' : '#3498db'}`,
        position: 'relative'
      }}>
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: '2px',
          background: 'linear-gradient(90deg, #667eea, #764ba2)',
          animation: 'glow 2s ease-in-out infinite'
        }}></div>

        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)' }}>
          <div style={{
            width: '60px',
            height: '60px',
            borderRadius: '50%',
            background: 'linear-gradient(135deg, #667eea, #764ba2)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            boxShadow: '0 0 30px rgba(102, 126, 234, 0.5)',
            animation: 'pulse 3s infinite'
          }}>
            <BarChart3 size={30} color="white" />
          </div>
          <div>
            <h1 style={{
              margin: 0,
              color: uiState.theme === 'dark' ? '#ffffff' : '#2c3e50',
              fontFamily: "'Poppins', sans-serif",
              fontWeight: 700,
              fontSize: '3em',
              background: uiState.theme === 'dark'
                ? 'linear-gradient(135deg, #667eea, #764ba2)'
                : 'linear-gradient(135deg, #3498db, #2ecc71)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              backgroundClip: 'text',
              textShadow: '0 0 20px rgba(102, 126, 234, 0.3)',
              animation: 'float 4s ease-in-out infinite'
            }}>
              Enhanced Dashboard
            </h1>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 'var(--spacing-md)',
              marginTop: 'var(--spacing-sm)',
              fontSize: '0.9em',
              color: uiState.theme === 'dark' ? '#ccc' : '#7f8c8d'
            }}>
              <div className={`status-enhanced ${uiState.connectionStatus === 'online' ? 'status-online' : 'status-offline'}`}>
                {uiState.connectionStatus === 'online' ? <Wifi size={12} /> : <WifiOff size={12} />}
                {uiState.connectionStatus === 'online' ? 'Online' : 'Offline'}
              </div>
              <span>Last updated: {uiState.lastUpdate.toLocaleTimeString()}</span>
            </div>
          </div>
        </div>

        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-md)' }}>
          <button
            onClick={toggleTheme}
            style={{
              padding: 'var(--spacing-sm)',
              background: 'rgba(255, 193, 77, 0.2)',
              border: '1px solid #ffc14d',
              borderRadius: '50%',
              color: '#ffc14d',
              cursor: 'pointer'
            }}
            title={`Switch to ${uiState.theme === 'dark' ? 'Light' : 'Dark'} Theme`}
          >
            {uiState.theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
          </button>

          <button
            onClick={fetchData}
            style={{
              padding: 'var(--spacing-sm) var(--spacing-md)',
              background: 'linear-gradient(135deg, #667eea, #764ba2)',
              border: 'none',
              borderRadius: '25px',
              color: 'white',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: 'var(--spacing-xs)',
              boxShadow: '0 4px 15px rgba(102, 126, 234, 0.3)'
            }}
          >
            <RefreshCw size={16} />
            Refresh
          </button>
        </div>
      </div>

      {/* Filters */}
      <div className="enhanced-card" style={{
        marginBottom: 'var(--spacing-xl)',
        display: 'flex',
        gap: 'var(--spacing-md)',
        alignItems: 'center',
        flexWrap: 'wrap'
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-xs)' }}>
          <Filter size={18} color="#667eea" />
          <span style={{ color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontWeight: '500', fontSize: '1.1em' }}>Filters:</span>
        </div>

        <select
          value={filters.dateRange}
          onChange={(e) => setFilters({ ...filters, dateRange: e.target.value })}
          style={{
            padding: 'var(--spacing-xs) var(--spacing-sm)',
            background: uiState.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            border: `1px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.3)' : 'rgba(44, 62, 80, 0.2)'}`,
            borderRadius: '6px',
            color: uiState.theme === 'dark' ? 'white' : '#2c3e50'
          }}
        >
          <option value="1d">Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
        </select>

        <select
          value={filters.project}
          onChange={(e) => setFilters({ ...filters, project: e.target.value })}
          style={{
            padding: 'var(--spacing-xs) var(--spacing-sm)',
            background: uiState.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            border: `1px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.3)' : 'rgba(44, 62, 80, 0.2)'}`,
            borderRadius: '6px',
            color: uiState.theme === 'dark' ? 'white' : '#2c3e50'
          }}
        >
          <option value="all">All Projects</option>
          {data.projects.map(p => (
            <option key={p.id} value={p.id}>{p.name}</option>
          ))}
        </select>

        <select
          value={filters.staff}
          onChange={(e) => setFilters({ ...filters, staff: e.target.value })}
          style={{
            padding: 'var(--spacing-xs) var(--spacing-sm)',
            background: uiState.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            border: `1px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.3)' : 'rgba(44, 62, 80, 0.2)'}`,
            borderRadius: '6px',
            color: uiState.theme === 'dark' ? 'white' : '#2c3e50'
          }}
        >
          <option value="all">All Staff</option>
          {data.staff.map(s => (
            <option key={s.id} value={s.id}>{s.name}</option>
          ))}
        </select>
      </div>

      {/* Widgets Grid */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
        gap: 'var(--spacing-xl)',
        marginBottom: 'var(--spacing-xl)'
      }}>
        {/* KPI Cards */}
        {widgets.kpi.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.kpi.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <BarChart3 size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>Key Performance Indicators</h3>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 'var(--spacing-md)' }}>
              <div style={{
                background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                textAlign: 'center',
                border: '1px solid rgba(102, 126, 234, 0.3)'
              }}>
                <DollarSign size={32} color="#667eea" style={{ marginBottom: 'var(--spacing-sm)' }} />
                <div className="kpi-enhanced">${analytics.totalRevenue?.toLocaleString() || '0'}</div>
                <div className="metric-enhanced">Total Revenue</div>
              </div>

              <div style={{
                background: 'linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(70, 160, 140, 0.2))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                textAlign: 'center',
                border: '1px solid rgba(78, 205, 196, 0.3)'
              }}>
                <Target size={32} color="#4ecdc4" style={{ marginBottom: 'var(--spacing-sm)' }} />
                <div className="kpi-enhanced">{analytics.avgMargin?.toFixed(1) || '0.0'}%</div>
                <div className="metric-enhanced">Avg Margin</div>
              </div>

              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 193, 77, 0.2), rgba(255, 160, 0, 0.2))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                textAlign: 'center',
                border: '1px solid rgba(255, 193, 77, 0.3)'
              }}>
                <Clock size={32} color="#ffd93d" style={{ marginBottom: 'var(--spacing-sm)' }} />
                <div className="kpi-enhanced">{analytics.diaryCount || '0'}</div>
                <div className="metric-enhanced">Total Entries</div>
              </div>

              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(220, 53, 69, 0.2))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                textAlign: 'center',
                border: '1px solid rgba(255, 107, 107, 0.3)'
              }}>
                <Users size={32} color="#ff6b6b" style={{ marginBottom: 'var(--spacing-sm)' }} />
                <div className="kpi-enhanced">{analytics.staffCount || '0'}</div>
                <div className="metric-enhanced">Active Staff</div>
              </div>
            </div>
          </div>
        )}

        {/* Charts Widget */}
        {widgets.charts.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.charts.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <TrendingUp size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>Revenue Trends</h3>
            </div>

            <div style={{ height: '300px' }}>
              <Line
                data={{
                  labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                  datasets: [
                    {
                      label: 'Revenue ($)',
                      data: [1200, 1500, 1800, 2100, 1900, 2200, 2500],
                      borderColor: '#667eea',
                      backgroundColor: 'rgba(102, 126, 234, 0.1)',
                      tension: 0.4
                    }
                  ]
                }}
                options={{
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { labels: { color: uiState.theme === 'dark' ? 'white' : '#2c3e50' } }
                  },
                  scales: {
                    x: { ticks: { color: uiState.theme === 'dark' ? 'white' : '#2c3e50' }, grid: { color: uiState.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } },
                    y: {
                      ticks: { color: uiState.theme === 'dark' ? 'white' : '#2c3e50' },
                      grid: { color: uiState.theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                      title: { display: true, text: 'Revenue ($)', color: uiState.theme === 'dark' ? 'white' : '#2c3e50' }
                    }
                  }
                }}
              />
            </div>
          </div>
        )}

        {/* AI Insights */}
        {widgets.insights.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.insights.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <Brain size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>AI Insights</h3>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-md)' }}>
              <div style={{
                background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                border: '1px solid rgba(102, 126, 234, 0.3)'
              }}>
                <h4 style={{ margin: '0 0 var(--spacing-sm) 0', color: '#667eea' }}>Performance Analysis</h4>
                <p style={{ margin: 0, color: uiState.theme === 'dark' ? '#ccc' : '#7f8c8d', lineHeight: '1.5' }}>
                  Your team's productivity is {(analytics.staffCount || 0) > 5 ? 'excellent' : 'good'}.
                  Consider optimizing resource allocation.
                </p>
              </div>

              <div style={{
                background: 'linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(70, 160, 140, 0.1))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                border: '1px solid rgba(78, 205, 196, 0.3)'
              }}>
                <h4 style={{ margin: '0 0 var(--spacing-sm) 0', color: '#4ecdc4' }}>Revenue Optimization</h4>
                <p style={{ margin: 0, color: uiState.theme === 'dark' ? '#ccc' : '#7f8c8d', lineHeight: '1.5' }}>
                  AI suggests focusing on high-margin projects. Current ROI: {analytics.roi || '0'}%.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Predictive Analytics */}
        {widgets.predictive.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.predictive.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <Zap size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>Predictive Analytics</h3>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-md)' }}>
              <div style={{
                background: 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))',
                padding: 'var(--spacing-md)',
                borderRadius: '12px',
                border: '1px solid rgba(102, 126, 234, 0.3)'
              }}>
                <h4 style={{ margin: '0 0 var(--spacing-sm) 0', color: '#667eea' }}>Next Month Forecast</h4>
                <div style={{ fontSize: '2em', fontWeight: 'bold', color: '#4ecdc4' }}>
                  ${((analytics.totalRevenue || 0) * 1.15).toLocaleString()}
                </div>
                <div style={{ color: uiState.theme === 'dark' ? '#ccc' : '#7f8c8d' }}>Projected Revenue</div>
              </div>
            </div>
          </div>
        )}

        {/* Heatmap */}
        {widgets.heatmap.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.heatmap.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <Zap size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>Project Heatmap</h3>
            </div>

            <div style={{ overflowX: 'auto' }}>
              <svg ref={heatmapRef} style={{ minWidth: '600px', height: '300px' }}></svg>
            </div>
          </div>
        )}

        {/* Recent Activities */}
        {widgets.activities.visible && (
          <div className="enhanced-card" style={{
            gridColumn: widgets.activities.size === 'large' ? 'span 2' : 'span 1'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 'var(--spacing-sm)', marginBottom: 'var(--spacing-lg)' }}>
              <Activity size={24} color="#667eea" />
              <h3 style={{ margin: 0, color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>Recent Activities</h3>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--spacing-sm)' }}>
              {data.diaries.slice(-5).reverse().map(d => (
                <div key={d.id} style={{
                  padding: 'var(--spacing-md)',
                  border: `1px solid ${uiState.theme === 'dark' ? 'rgba(102, 126, 234, 0.3)' : 'rgba(44, 62, 80, 0.2)'}`,
                  borderRadius: '10px',
                  background: uiState.theme === 'dark' ? 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))' : 'linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1))',
                  transition: 'all 0.3s ease',
                  cursor: 'pointer'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.transform = 'translateY(-2px)'
                  e.currentTarget.style.boxShadow = uiState.theme === 'dark' ? '0 6px 20px rgba(102, 126, 234, 0.4)' : '0 6px 20px rgba(52, 152, 219, 0.3)'
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.transform = 'translateY(0)'
                  e.currentTarget.style.boxShadow = 'none'
                }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <strong style={{ color: uiState.theme === 'dark' ? 'white' : '#2c3e50', fontFamily: "'Poppins', sans-serif" }}>
                        {d.Staff?.name || 'Staff'} → {d.Project?.name || 'Project'}
                      </strong>
                      <br />
                      <small style={{ color: uiState.theme === 'dark' ? '#ccc' : '#7f8c8d', fontFamily: "'Inter', sans-serif" }}>
                        {d.date} • {d.totalHours || 0}h worked
                      </small>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ color: '#4ecdc4', fontWeight: 'bold', fontSize: '1.1em' }}>
                        ${d.revenues || 0}
                      </div>
                      <div style={{
                        color: (d.marginPct || 0) >= 0 ? '#4ecdc4' : '#e74c3c',
                        fontSize: '0.9em'
                      }}>
                        {(d.marginPct || 0).toFixed(1)}%
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* Footer Controls */}
      <div className="enhanced-card" style={{
        display: 'flex',
        gap: 'var(--spacing-md)',
        justifyContent: 'center',
        alignItems: 'center',
        flexWrap: 'wrap',
        marginTop: 'var(--spacing-xl)'
      }}>
        <button style={{
          padding: 'var(--spacing-sm) var(--spacing-md)',
          background: 'linear-gradient(135deg, #28a745, #20c997)',
          border: 'none',
          borderRadius: '8px',
          color: 'white',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: 'var(--spacing-xs)'
        }} onClick={() => handleExport('json')}>
          <Download size={16} />
          Export JSON
        </button>
      </div>
    </div>
  )
}

export default UltimateDashboardFinalEnhanced